{% extends "blog_base.html" %}
{% block title %}Content Studio | Tuka Advisory{% endblock %}

{% block content %}
<div class="studio-container">
    <form id="createBlogForm" method="POST" action="{{ url_for('admin.create_blog') }}" enctype="multipart/form-data">
        
        <header class="studio-header">
            <div class="header-info">
                <a href="{{ url_for('admin.dashboard') }}" class="back-link"><i class="fas fa-arrow-left"></i></a>

                <div>
                    <h1>Content Studio</h1>
                    <p class="desktop-only">Professional drafting with live preview</p>
                </div>
            </div>
            <div class="header-actions">
                <select name="status" class="status-select">
                    <option value="published" {% if blog and blog.status == 'published' %}selected{% endif %}>Publish</option>
                    <option value="draft" {% if blog and blog.status == 'draft' %}selected{% endif %}>Draft</option>
                </select>
                <button type="submit" class="btn-publish" onclick="
                    if (!document.getElementById('featuredImgInput').files.length && !document.getElementById('existing-img')) {
                        return confirm('Publish this blog without a featured image?');
                    }
                ">Save Post</button>
            </div>
        </header>

        <div class="studio-layout">
            <div class="editor-pane">
                <div class="meta-inputs">
                    <input type="text" name="title" id="blogTitleInput" class="title-input" placeholder="Enter post title..." value="{{ blog['title'] if blog else '' }}" required>
                    
                    <div class="thumbnail-upload">
                        <label for="featuredImgInput">
                            <i class="fas fa-image"></i>
                            <span>Featured Thumbnail</span>
                        </label>
                        <input type="file" name="image" id="featuredImgInput" accept="image/*" hidden>
                        <div id="file-name" class="file-name">{% if blog and blog['image'] %}{{ blog['image'] }}{% else %}No file chosen{% endif %}</div>
                    </div>
                </div>

                <div class="editor-container">
                    <div id="toolbar-container"></div>
                    <div class="editor-scroll-area">
                        <div id="editor-canvas" class="article-content">
                            {% if blog and blog['content'] %}
                                {{ blog['content'] | safe }}
                            {% else %}
                                <h2>Write something impactful...</h2>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <aside class="preview-pane">
                <div class="preview-card">
                    <div class="preview-tag">LIVE PREVIEW</div>
                    <div id="previewImageArea" style="margin-bottom: 20px;">
                        {% if blog and blog['image'] %}
                            <img src="{{ url_for('static', filename='uploads/blogs/' ~ blog['image']) }}" id="existing-img" style="width:100%; border-radius:8px; display:block;">
                        {% endif %}
                    </div>
                    <h2 id="previewTitle" style="margin-bottom: 15px;">{{ blog['title'] if blog else '' }}</h2>
                    <div id="previewContent" class="article-content">
                        {% if blog and blog['content'] %}
                            {{ blog['content'] | safe }}
                        {% else %}
                            <p style="color: #94a3b8;">Content will appear here as you type...</p>
                        {% endif %}
                    </div>
                </div>
            </aside>
        </div>

        <input type="hidden" name="content" id="hiddenContent">
    </form>
</div>

<script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/decoupled-document/ckeditor.js"></script>

<script>
let editorInstance;

class Base64UploadAdapter {
    constructor(loader) { this.loader = loader; }
    upload() {
        return this.loader.file.then(file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve({ default: reader.result });
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        }));
    }
}

function MyCustomUploadAdapterPlugin(editor) {
    editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
        return new Base64UploadAdapter(loader);
    };
}

DecoupledEditor
    .create(document.querySelector('#editor-canvas'), {
        extraPlugins: [MyCustomUploadAdapterPlugin],
        toolbar: {
            items: [
                'heading', '|', 'bold', 'italic', 'underline', '|',
                'bulletedList', 'numberedList', 'alignment', '|',
                'link', 'uploadImage', 'insertTable', 'blockQuote', '|', 'undo', 'redo'
            ]
        }
    })
    .then(editor => {
        editorInstance = editor;
        document.querySelector('#toolbar-container').appendChild(editor.ui.view.toolbar.element);

        // Set initial hidden content
        document.getElementById('hiddenContent').value = editor.getData();

        editor.model.document.on('change:data', () => {
            const data = editor.getData();
            document.getElementById('hiddenContent').value = data;
            document.getElementById('previewContent').innerHTML = data;
        });
    })
    .catch(error => console.error(error));

// Live Title Preview
document.getElementById('blogTitleInput').addEventListener('input', function() {
    document.getElementById('previewTitle').innerText = this.value;
});

// File name display and Live Image Preview
document.getElementById('featuredImgInput').onchange = function() {
    const file = this.files[0];
    if (file) {
        document.getElementById('file-name').innerText = file.name;
        
        // Update Live Preview with selected image
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewArea = document.getElementById('previewImageArea');
            previewArea.innerHTML = `<img src="${e.target.result}" style="width:100%; border-radius:8px; display:block;">`;
        }
        reader.readAsDataURL(file);
    } else {
        document.getElementById('file-name').innerText = 'No file chosen';
    }
};
</script>

<style>
/* Your original styles are preserved exactly. 
   I added one helper class to ensure images in 
   preview don't break the layout. 
*/
:root {
    --studio-bg: #0f172a;
    --pane-bg: #1e293b;
    --text-main: #f8fafc;
    --accent-blue: #3b82f6;
    --border-color: rgba(255, 255, 255, 0.1);
}

.studio-container {
    background: var(--studio-bg);
    min-height: 100vh;
    color: var(--text-main);
}

.studio-header {
    background: var(--pane-bg);
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-info { display: flex; align-items: center; gap: 15px; }
.back-link { color: var(--text-main); font-size: 1.2rem; }
.studio-header h1 { font-size: 1.1rem; font-weight: 700; margin: 0; }
.studio-header p { font-size: 0.75rem; opacity: 0.6; margin: 0; }

.header-actions { display: flex; gap: 10px; }
.status-select { background: #334155; color: white; border: none; padding: 8px; border-radius: 6px; font-size: 0.8rem; }
.btn-publish { background: var(--accent-blue); color: white; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }

.studio-layout {
    display: grid;
    grid-template-columns: 1fr 400px;
    height: calc(100vh - 65px);
}

.editor-pane { 
    display: flex; 
    flex-direction: column; 
    background: #f1f5f9; 
    color: #1e293b;
}

.preview-pane {
    background: var(--studio-bg);
    padding: 20px;
    overflow-y: auto;
    border-left: 1px solid var(--border-color);
}

.meta-inputs { padding: 20px; background: white; border-bottom: 1px solid #e2e8f0; }
.title-input { 
    width: 100%; border: none; font-size: 1.8rem; font-weight: 800; 
    outline: none; color: #0f172a; margin-bottom: 15px;
}

.thumbnail-upload label {
    display: inline-flex; align-items: center; gap: 8px;
    background: #f8fafc; padding: 8px 15px; border-radius: 6px;
    border: 1px solid #e2e8f0; cursor: pointer; font-size: 0.85rem;
}

#toolbar-container {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    position: sticky;
    top: 0;
    z-index: 10;
}

.editor-scroll-area { flex: 1; overflow-y: auto; padding: 40px 20px; background: #e2e8f0; }

#editor-canvas {
    background: white !important;
    width: 100%;
    max-width: 800px;
    min-height: 1000px;
    margin: 0 auto;
    padding: 50px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    outline: none;
}

.preview-card { background: white; border-radius: 12px; padding: 25px; color: #1e293b; min-height: 100%; }
.preview-tag { font-size: 0.65rem; font-weight: 900; color: var(--accent-blue); margin-bottom: 20px; letter-spacing: 1px; }

/* Fixed: Added to ensure preview images don't overflow */
.preview-card img { max-width: 100%; height: auto; border-radius: 8px; }

@media (max-width: 1024px) {
    .studio-layout { grid-template-columns: 1fr; }
    .preview-pane { display: none; }
    .desktop-only { display: none; }
    
    .editor-scroll-area { padding: 0; background: white; }
    #editor-canvas { padding: 20px !important; box-shadow: none; min-height: calc(100vh - 250px); }
    .title-input { font-size: 1.4rem; }
    .ck-toolbar { flex-wrap: nowrap !important; overflow-x: auto !important; }
}
</style>
{% endblock %}