<!--services/finance/user/templates/fin_edit_loan.html-->
{% extends "fin_base.html" %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Loan Application | Tukakombe Loans</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
        :root{--navy:#1a2a40;--navy-dark:#0d1621;--navy-light:#2c3e5a;--lime:#a2d242;--lime-light:#c5e86c;--lime-dark:#8eb936;--teal:#4ecdc4;--white:#fff;--off-white:#f8fafc;--cream:#fef6e4;--transition:all .3s ease}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}body{background:var(--off-white);color:var(--navy-dark);line-height:1.6;padding-bottom:50px}
        .header{background:var(--navy);color:var(--white);padding:15px 0;position:sticky;top:0;z-index:1000}.header-container{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 20px}.logo{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:800}.logo span{color:var(--lime)}
        .main-content{max-width:900px;margin:30px auto;padding:0 20px}
        .loan-type-selector{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:30px 0}.type-card{background:#fff;border-radius:16px;padding:40px 30px;text-align:center;cursor:pointer;border:2px solid #e2e8f0;transition:var(--transition)}.type-card:hover{transform:translateY(-5px);border-color:var(--teal);box-shadow:0 10px 25px rgba(0,0,0,.1)}.type-card.active{border-color:var(--lime);background:rgba(162,210,66,.05)}.type-icon{font-size:48px;margin-bottom:20px;color:var(--navy-light)}.type-title{font-size:24px;font-weight:700;margin-bottom:10px;color:var(--navy)}.type-desc{color:#64748b;font-size:14px}
        .steps-container{display:flex;justify-content:space-between;margin-bottom:30px;position:relative}.steps-container::before{content:'';position:absolute;top:20px;left:0;width:100%;height:2px;background:#cbd5e1;z-index:1}.step{width:40px;height:40px;border-radius:50%;background:#fff;border:2px solid #cbd5e1;display:flex;align-items:center;justify-content:center;z-index:2;font-weight:700;cursor:pointer;transition:var(--transition)}.step:hover{border-color:var(--lime-light)}.step.active{border-color:var(--lime);background:var(--lime);color:var(--navy)}.step.completed{background:var(--teal);border-color:var(--teal);color:#fff}
        .form-card{background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.05);overflow:hidden;display:none}.form-card.active{display:block;animation:fadeIn .4s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .card-header{background:var(--navy);color:#fff;padding:20px 30px}.card-body{padding:30px}
        .form-group{margin-bottom:20px}label{display:block;font-weight:600;margin-bottom:8px;color:var(--navy)}.form-control{width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:8px;font-size:15px}.required{color:#e74c3c}
        .category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:25px}.category-btn{padding:15px;border:2px solid #e2e8f0;border-radius:12px;text-align:center;cursor:pointer;transition:var(--transition);background:#fff}.category-btn i{display:block;font-size:24px;margin-bottom:8px;color:var(--navy-light)}.category-btn:hover{border-color:var(--teal)}.category-btn.active{border-color:var(--lime);background:rgba(162,210,66,.05)}
        .items-container{display:none;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;padding:15px;background:var(--off-white);border-radius:12px;margin-bottom:20px}.items-container.active{display:grid}.item-check{display:flex;align-items:center;gap:10px;padding:10px;background:#fff;border:1px solid #eee;border-radius:8px}
        .upload-slot{border:2px dashed #cbd5e1;padding:15px;border-radius:10px;margin-bottom:15px;transition:var(--transition)}.upload-slot:hover{border-color:var(--teal);background:rgba(78,205,196,.02)}.slot-title{font-weight:700;display:flex;align-items:center;gap:8px;font-size:14px}.slot-desc{font-size:12px;color:#64748b;margin-top:4px}.optional-badge{background:#f0f0f0;color:#666;padding:2px 8px;border-radius:4px;font-size:10px;margin-left:8px}
        .sig-toggle{display:flex;gap:10px;margin-bottom:15px}.sig-method{flex:1;padding:10px;text-align:center;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:14px}.sig-method.active{background:var(--navy);color:#fff;border-color:var(--navy)}#sig-upload-box,#sig-draw-box{display:none}#sig-upload-box.active,#sig-draw-box.active{display:block}canvas{border:1px solid #ddd;width:100%;height:150px;background:#fff;border-radius:8px}
        .btn-group{display:flex;justify-content:space-between;margin-top:30px}.btn{padding:12px 25px;border-radius:8px;font-weight:700;cursor:pointer;border:none;transition:var(--transition)}.btn-next{background:var(--lime);color:var(--navy)}.btn-back{background:transparent;border:1px solid #cbd5e1}
        .calc-summary{background:var(--cream);padding:15px;border-radius:10px;border-left:4px solid var(--lime);margin-top:15px}
        .other-input-container{display:none;margin-top:15px}.other-input-container.active{display:block}
        .btn-back-type{background:#64748b;color:#fff;border:none}.btn-back-type:hover{background:#475569}
        .alert{padding:15px;border-radius:8px;margin:20px 0;display:block;animation:fadeIn .3s ease}.alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.alert-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.alert-info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}.alert-close{float:right;background:0;border:0;font-size:20px;cursor:pointer;color:inherit}
        .admin-note{background:var(--cream);padding:15px;border-radius:10px;border-left:4px solid var(--teal);margin-bottom:20px}
        .info-note{background:#e8f4fd;color:#0c5460;padding:12px;border-radius:8px;border-left:4px solid #17a2b8;margin-bottom:20px;font-size:14px}
        .existing-file{background:#f8f9fa;padding:10px;border-radius:6px;border:1px dashed #6c757d;margin-bottom:10px;font-size:13px}
        .file-info{display:flex;align-items:center;gap:10px}
        .current-value{background:#e8f5e8;padding:8px 12px;border-radius:6px;margin-top:5px;font-size:14px;border-left:3px solid #28a745}
        .edit-hint{color:#6c757d;font-size:13px;margin-top:5px;font-style:italic}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">Tuka<span>kombe</span> Loans</div>
            <div style="font-size:14px"><i class="fas fa-phone"></i> +260 967651727</div>
        </div>
    </header>
    <main class="main-content">
        <div style="margin-bottom: 20px;">
            <a href="{{ url_for('finance.my_loans') }}" style="text-decoration: none; color: var(--navy-light); font-weight: 600;">
                <i class="fas fa-arrow-left"></i> Back to My Loans
            </a>
        </div>

        {% with messages=get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category,message in messages %}
                    <div class="alert alert-{{category if category!='message' else 'success'}}" id="backend-message">{{message}}<button class="alert-close" onclick="this.parentElement.style.display='none'">Ã—</button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if loan.admin_notes %}
        <div class="admin-note">
            <strong style="color: var(--navy);"><i class="fas fa-info-circle"></i> Message from Advisor:</strong>
            <p style="margin-top:5px; font-size: 14px;">{{ loan.admin_notes }}</p>
        </div>
        {% endif %}

        <div class="info-note">
            <i class="fas fa-edit"></i> <strong>Editing Application #{{ loan.application_number }}</strong>
            <p style="margin-top:5px; margin-bottom:0;">Status: <strong>{{ loan.status|title }}</strong> | Applied: {{ loan.applied_date|datetimeformat }}</p>
            <p style="margin-top:5px; margin-bottom:0;">You can update your information below. Leave file uploads empty to keep existing documents.</p>
        </div>

        {% if loan.loan_type == 'personal' %}
        <form id="individualForm" method="POST" action="{{ url_for('finance.edit_loan', loan_id=loan.id) }}" enctype="multipart/form-data">
            <input type="hidden" name="loan_type" id="loan_type_ind" value="personal">
            <div class="steps-container">
                <div class="step active" id="ind-dot1" onclick="goToStep('ind', 1)">1</div>
                <div class="step" id="ind-dot2" onclick="goToStep('ind', 2)">2</div>
                <div class="step" id="ind-dot3" onclick="goToStep('ind', 3)">3</div>
                <div class="step" id="ind-dot4" onclick="goToStep('ind', 4)">4</div>
            </div>
            <div class="form-card active" id="ind-step1">
                <div class="card-header"><h2><i class="fas fa-money-bill-wave"></i> Loan Details</h2></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Loan Amount (ZMW) <span class="required">*</span></label>
                        <input type="number" name="ind-amt" id="ind-amt" class="form-control" value="{{ loan.loan_amount or details.loan_amount }}" required min="100" oninput="updateIndCalc()">
                        <div class="edit-hint">Original amount: K{{ loan.loan_amount|default('0.00') }}</div>
                    </div>
                    <div class="form-group"><label>Purpose of Loan <span class="required">*</span></label>
                        <select name="ind-purpose" id="ind-purpose" class="form-control" required>
                            <option value="">Select purpose</option>
                            <option value="education" {% if details.purpose == 'education' %}selected{% endif %}>Education Fees</option>
                            <option value="medical" {% if details.purpose == 'medical' %}selected{% endif %}>Medical Expenses</option>
                            <option value="home" {% if details.purpose == 'home' %}selected{% endif %}>Home Improvement</option>
                            <option value="vehicle" {% if details.purpose == 'vehicle' %}selected{% endif %}>Vehicle Purchase</option>
                            <option value="debt" {% if details.purpose == 'debt' %}selected{% endif %}>Debt Consolidation</option>
                            <option value="other" {% if details.purpose == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Repayment Period<span class="required">*</span></label>
                        <select name="ind-period" id="ind-period" class="form-control" required onchange="updateIndCalc()">
                            <option value="6" {% if details.repayment_period_days == 6 %}selected{% endif %}>1 Week</option>
                            <option value="8" {% if details.repayment_period_days == 8 %}selected{% endif %}>2 Weeks</option>
                            <option value="14" {% if details.repayment_period_days == 14 %}selected{% endif %}>3 Weeks</option>
                            <option value="16" {% if details.repayment_period_days == 16 %}selected{% endif %}>1 Month</option>
                            <option value="22" {% if details.repayment_period_days == 22 %}selected{% endif %}>5 Weeks</option>
                            <option value="24" {% if details.repayment_period_days == 24 %}selected{% endif %}>6 Weeks</option>
                            <option value="30" {% if details.repayment_period_days == 30 %}selected{% endif %}>7 Weeks</option>
                            <option value="32" {% if details.repayment_period_days == 32 %}selected{% endif %}>2 Months</option>
                            <option value="48" {% if details.repayment_period_days == 48 %}selected{% endif %}>3 Months</option>
                        </select>
                    </div>
                    <div class="calc-summary">
                        <div id="ind-totalRepay">Total Repayment: K 0.00</div>
                        <div id="ind-weeklyRepay">Weekly: K 0.00</div>
                        <div id="ind-interestRate" style="font-size:12px; color:#666; margin-top:5px;">Interest Rate: 0%</div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-back" onclick="window.history.back()"><i class="fas fa-arrow-left"></i> Back to Loans</button>
                        <button type="button" class="btn btn-next" onclick="validateAndProceed('ind',1,2)">Next: Collateral <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="form-card" id="ind-step2">
                <div class="card-header"><h2><i class="fas fa-boxes"></i> Collateral Selection</h2></div>
                <div class="card-body">
                    <div class="info-note" style="margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Collateral items cannot be changed after submission. Please contact support for major collateral changes.
                    </div>
                    
                    {% if collateral_items %}
                    <div class="existing-file">
                        <div class="file-info">
                            <i class="fas fa-check-circle" style="color: #28a745;"></i>
                            <div>
                                <strong>Existing Collateral Items:</strong>
                                {% for item in collateral_items %}
                                <div>{{ item.item_name }} - {{ item.condition_description[:50] }}{% if item.condition_description|length > 50 %}...{% endif %}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label>Item Description & Condition</label>
                        <textarea name="ind-description" id="ind-description" class="form-control" rows="3" placeholder="Brand, Model, Serial Number, Working condition...">{{ details.condition_description or '' }}</textarea>
                    </div>
                    <div class="form-group"><label>Update Photos of Collateral Items</label>
                        <div class="upload-slot" style="margin-bottom:10px">
                            <div class="slot-title"><i class="fas fa-images"></i> Collateral Images</div>
                            <div class="slot-desc">Upload new photos to replace existing ones (optional). Leave empty to keep current photos.</div>
                            <input type="file" name="ind-collateral-photos" id="ind-collateral-photos" class="form-control" style="margin-top:10px" accept=".jpg,.jpeg,.png,.heic" multiple>
                        </div>
                    </div>
                    <div class="form-group"><label>Update Serial Number/ID Proof (Optional)</label>
                        <div class="upload-slot">
                            <div class="slot-title"><i class="fas fa-barcode"></i> Serial Number/ID Documents <span class="optional-badge">Optional</span></div>
                            <div class="slot-desc">Upload photos showing serial numbers, model numbers, or any identification marks</div>
                            <input type="file" name="ind-serial-photos" id="ind-serial-photos" class="form-control" style="margin-top:10px" accept=".jpg,.jpeg,.png,.heic,.pdf" multiple>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-back" onclick="showIndStep(1)">Back</button>
                        <button type="button" class="btn btn-next" onclick="validateAndProceed('ind',2,3)">Next: KYC Documents <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="form-card" id="ind-step3">
                <div class="card-header"><h2><i class="fas fa-id-card"></i> Personal & KYC Documents</h2></div>
                <div class="card-body">
                    <div class="form-group"><label>Full Name <span class="required">*</span></label>
                        <input type="text" name="ind-name" id="ind-name" class="form-control" value="{{ details.full_name }}" required>
                    </div>
                    <div class="form-group"><label>Date of Birth <span class="required">*</span></label>
                        <input type="date" name="ind-dob" id="ind-dob" class="form-control" value="{{ details.date_of_birth }}" required>
                    </div>
                    <div class="form-group"><label>NRC Number <span class="required">*</span></label>
                        <input type="text" name="ind-nrc" id="ind-nrc" class="form-control" value="{{ details.nrc_number }}" placeholder="e.g., 123456/78/9" required pattern="\d{6}\/\d{2}\/\d{1}">
                    </div>
                    <div class="form-group"><label>Email <span class="required">*</span></label>
                        <input type="email" name="ind-email" id="ind-email" class="form-control" value="{{ details.email }}" required>
                    </div>
                    <div class="form-group"><label>Phone Number <span class="required">*</span></label>
                        <input type="tel" name="ind-phone" id="ind-phone" class="form-control" value="{{ details.phone_number }}" required>
                    </div>
                    <div class="form-group"><label>Residential Address <span class="required">*</span></label>
                        <textarea name="ind-address" id="ind-address" class="form-control" rows="2" required>{{ details.residential_address }}</textarea>
                    </div>
                    
                    {% if attachments %}
                    <div class="existing-file">
                        <div class="file-info">
                            <i class="fas fa-file-alt" style="color: #17a2b8;"></i>
                            <div>
                                <strong>Existing Documents:</strong>
                                {% for att in attachments %}
                                {% if att.document_category in ['ID Copy', 'Proof of Residence', 'Proof of Income', 'Signature'] %}
                                <div>{{ att.document_category }} - {{ att.file_name }}</div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="upload-slot">
                        <div class="slot-title"><i class="fas fa-passport"></i> 1. Update Proof of Identity</div>
                        <div class="slot-desc">Upload NRC, Passport, or Driver's License (PDF, JPG, PNG). Leave empty to keep current.</div>
                        <input type="file" name="ind-identity" id="ind-identity" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="upload-slot">
                        <div class="slot-title"><i class="fas fa-home"></i> 2. Update Proof of Residence</div>
                        <div class="slot-desc">Utility bill, Rent agreement, or Utility bill + Landlord agreement. Leave empty to keep current.</div>
                        <input type="file" name="ind-residence" id="ind-residence" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="upload-slot">
                        <div class="slot-title"><i class="fas fa-file-invoice"></i> 3. Update Proof of Income <span class="optional-badge">Optional</span></div>
                        <div class="slot-desc">Recent payslips (last 3 months) or bank statements. Leave empty to keep current.</div>
                        <input type="file" name="ind-income" id="ind-income" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-back" onclick="showIndStep(2)">Back</button>
                        <button type="button" class="btn btn-next" onclick="validateAndProceed('ind',3,4)">Next: Agreement <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="form-card" id="ind-step4">
                <div class="card-header"><h2><i class="fas fa-pen-fancy"></i> Finalize Agreement</h2></div>
                <div class="card-body">
                    <label>How would you like to sign? <span class="required">*</span></label>
                    <div class="sig-toggle">
                        <div class="sig-method active" onclick="toggleSig('draw')">Draw New Signature</div>
                        <div class="sig-method" onclick="toggleSig('upload')">Upload New Signature</div>
                    </div>
                    <div id="sig-draw-box" class="active">
                        <canvas id="sig-canvas-ind"></canvas>
                        <button type="button" class="btn btn-back" style="margin-top:5px;padding:5px 10px" onclick="clearIndSig()">Clear</button>
                        <input type="hidden" name="ind-signature-data" id="ind-signature-data">
                    </div>
                    <div id="sig-upload-box">
                        <label>Upload New Signature Image</label>
                        <input type="file" name="ind-sig-upload" id="ind-sig-upload" class="form-control" accept=".png,.jpg,.jpeg">
                    </div>
                    
                    <div class="existing-file" style="margin-top: 20px;">
                        <div class="file-info">
                            <i class="fas fa-signature" style="color: #6c757d;"></i>
                            <div>
                                <strong>Existing Signature:</strong>
                                <div>Keep current signature if you don't draw/upload a new one</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top:20px">
                        <label style="font-weight:normal;font-size:13px">
                            <input type="checkbox" name="ind-agreement" id="ind-agreement" required> 
                            I agree that the updated information provided is true and I accept the terms of Tukakombe Loans.
                        </label>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-back" onclick="showIndStep(3)">Back</button>
                        <button type="submit" class="btn btn-next" style="background:var(--teal);color:#fff">Update Application</button>
                    </div>
                </div>
            </div>
        </form>
        {% else %}
        <form id="businessForm" method="POST" action="{{ url_for('finance.edit_loan', loan_id=loan.id) }}" enctype="multipart/form-data">
            <input type="hidden" name="loan_type" id="loan_type_bus" value="business">
            <div class="steps-container">
                <div class="step active" id="bus-dot1" onclick="goToStep('bus', 1)">1</div>
                <div class="step" id="bus-dot2" onclick="goToStep('bus', 2)">2</div>
                <div class="step" id="bus-dot3" onclick="goToStep('bus', 3)">3</div>
                <div class="step" id="bus-dot4" onclick="goToStep('bus', 4)">4</div>
                <div class="step" id="bus-dot5" onclick="goToStep('bus', 5)">5</div>
            </div>
            <div class="form-card active" id="bus-step1">
                <div class="card-header"><h2><i class="fas fa-building"></i> Business Details</h2></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Business Name <span class="required">*</span></label>
                        <input type="text" name="bus-name" id="bus-name" class="form-control" value="{{ details.business_name }}" required>
                    </div>
                    <div class="form-group">
                        <label>Business Registration Number <span class="required">*</span></label>
                        <input type="text" name="bus-reg" id="bus-reg" class="form-control" value="{{ details.business_registration_number }}" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person Name <span class="required">*</span></label>
                        <input type="text" name="bus-contact-name" id="bus-contact-name" class="form-control" value="{{ details.contact_person_name }}" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person Email <span class="required">*</span></label>
                        <input type="email" name="bus-contact-email" id="bus-contact-email" class="form-control" value="{{ details.contact_email }}" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person Phone <span class="required">*</span></label>
                        <input type="tel" name="bus-contact-phone" id="bus-contact-phone" class="form-control" value="{{ details.contact_phone }}" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person Position</label>
                        <input type="text" name="bus-contact-position" id="bus-contact-position" class="form-control" value="{{ details.contact_person_position }}" placeholder="e.g., Director, Manager">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-back" onclick="window.history.back()"><i class="fas fa-arrow-left"></i> Back to Loans</button>
                        <button type="button" class="btn btn-next" onclick="validateAndProceed('bus',1,2)">Next: Loan Request <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="form-card" id="bus-step2">
                <div class="card-header"><h2><i class="fas fa-money-bill-wave"></i> Loan Request</h2></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Loan Amount Required (ZMW) <span class="required">*</span></label>
                        <input type="number" name="bus-amt" id="bus-amt" class="form-control" value="{{ loan.loan_amount or details.loan_amount }}" placeholder="e.g., 50000" required min="1000" oninput="updateBusCalc()">
                        <div class="edit-hint">Original amount: K{{ loan.loan_amount|default('0.00') }}</div>
                    </div>
                    <div class="form-group">
                        <label>Reason for Borrowing <span class="required">*</span></label>
                        <select name="bus-purpose" id="bus-purpose" class="form-control" required>
                            <option value="">Select reason</option>
                            <option value="expansion" {% if details.purpose == 'expansion' %}selected{% endif %}>Business Expansion</option>
                            <option value="inventory" {% if details.purpose == 'inventory' %}selected{% endif %}>Inventory Purchase</option>
                            <option value="equipment" {% if details.purpose == 'equipment' %}selected{% endif %}>Equipment Purchase</option>
                            <option value="working-capital" {% if details.purpose == 'working-capital' %}selected{% endif %}>Working Capital</option>
                            <option value="renovation" {% if details.purpose == 'renovation' %}selected{% endif %}>Premises Renovation</option>
                            <option value="other" {% if details.purpose == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Detailed Reason <span class="required">*</span></label>
                        <textarea name="bus-reason" id="bus-reason" class="form-control" rows="4" placeholder="Provide detailed explanation of how the loan will be used..." required>{{ details.business_address or '' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Repayment Period<span class="required">*</span></label>
                        <select name="bus-period" id="bus-period" class="form-control" required onchange="updateBusCalc()">
                            <option value="6" {% if details.repayment_period_days == 6 %}selected{% endif %}>1 Week</option>
                            <option value="8" {% if details.repayment_period_days == 8 %}selected{% endif %}>2 Weeks</option>
                            <option value="14" {% if details.repayment_period_days == 14 %}selected{% endif %}>3 Weeks</option>
                            <option value="16" {% if details.repayment_period_days == 16 %}selected{% endif %}>1 Month</option>
                            <option value="22" {% if details.repayment_period_days == 22 %}selected{% endif %}>5 Weeks</option>
                            <option value="24" {% if details.repayment_period_days == 24 %}selected{% endif %}>6 Weeks</option>
                            <option value="30" {% if details.repayment_period_days == 30 %}selected{% endif %}>7 Weeks</option>
                            <option value="32" {% if details.repayment_period_days == 32 %}selected{% endif %}>2 Months</option>
                            <option value="48" {% if details.repayment_period_days == 48 %}selected{% endif %}>3 Months</option>
                        </select>
                    </div>
                    <div class="calc-summary">
                        <div id="bus-totalRepay">Total Repayment: K 0.00</div>
                        <div id="bus-weeklyRepay">Weekly: K 0.00</div>
                        <div id="bus-interestRate" style="font-size:12px; color:#666; margin-top:5px;">Interest Rate: 0%</div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-back" onclick="showBusStep(1)">Back</button>
                        <button type="button" class="btn btn-next" onclick="validateAndProceed('bus',2,3)">Next: Collateral <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="form-card" id="bus-step3">
                <div class="card-header"><h2><i class="fas fa-shield-alt"></i> Collateral & Security</h2></div>
                <div class="card-body">
                    <div class="info-note" style="margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Major collateral changes may require re-approval. Please contact support for significant changes.
                    </div>
                    
                    {% if collateral_items %}
                    <div class="existing-file">
                        <div class="file-info">
                            <i class="fas fa-check-circle" style="color: #28a745;"></i>
                            <div>
                                <strong>Existing Collateral:</strong>
                                {% for item in collateral_items %}
                                <div>{{ item.item_name }} - Value: K{{ item.estimated_value|default('0') }} - {{ item.condition_description[:50] }}{% if item.condition_description|length > 50 %}...{% endif %}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label>Type of Collateral <span class="required">*</span></label>
                        <select name="bus-collateral-type" id="bus-collateral-type" class="form-control" required>
                            <option value="">Select type</option>
                            <option value="property" {% if collateral_items and collateral_items[0].item_type == 'property' %}selected{% endif %}>Commercial Property</option>
                            <option value="equipment" {% if collateral_items and collateral_items[0].item_type == 'equipment' %}selected{% endif %}>Business Equipment</option>
                            <option value="inventory" {% if collateral_items and collateral_items[0].item_type == 'inventory' %}selected{% endif %}>Inventory Stock</option>
                            <option value="vehicle" {% if collateral_items and collateral_items[0].item_type == 'vehicle' %}selected{% endif %}>Business Vehicle</option>
                            <option value="guarantor" {% if collateral_items and collateral_items[0].item_type == 'guarantor' %}selected{% endif %}>Personal Guarantor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Collateral Description <span class="required">*</span></label>
                        <textarea name="bus-collateral-desc" id="bus-collateral-desc" class="form-control" rows="4" placeholder="Describe collateral in detail including value, condition, location..." required>{% if collateral_items %}{{ collateral_items[0].condition_description }}{% endif %}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Estimated Collateral Value (ZMW) <span class="required">*</span></label>
                        <input type="number" name="bus-collateral-value" id="bus-collateral-value" class="form-control" value="{% if collateral_items %}{{ collateral_items[0].estimated_value }}{% else %}0{% endif %}" required>
                    </div>
                    <div class="form-group">
                        <label>Update Collateral Ownership Proof</label>
                        <input type="file" name="bus-collateral-proof" id="bus-collateral-proof" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                        <div class="slot-desc">Title deed, purchase receipt, registration documents. Leave empty to keep current.</div>
                    </div>
                    <div class="form-group">
                        <label>Update Collateral Photos/Documents</label>
                        <div class="upload-slot" style="margin-bottom:10px">
                            <div class="slot-title"><i class="fas fa-camera"></i> Collateral Visual Documentation</div>
                            <div class="slot-desc">Upload new photos of collateral. Leave empty to keep current photos.</div>
                            <input type="file" name="bus-collateral-photos" id="bus-collateral-photos" class="form-control" style="margin-top:10px" accept=".jpg,.jpeg,.png,.heic" multiple>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Update Additional Collateral Documents</label>
                        <div class="upload-slot">
                            <div class="slot-title"><i class="fas fa-file-alt"></i> Supporting Documents <span class="optional-badge">Optional</span></div>
                            <div class="slot-desc">Upload any additional documents. Leave empty to keep current.</div>
                            <input type="file" name="bus-collateral-docs" id="bus-collateral-docs" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-back" onclick="showBusStep(2)">Back</button>
                        <button type="button" class="btn btn-next" onclick="validateAndProceed('bus',3,4)">Next: KYC Documents <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="form-card" id="bus-step4">
                <div class="card-header"><h2><i class="fas fa-file-contract"></i> Business KYC Documents</h2></div>
                <div class="card-body">
                    {% if attachments %}
                    <div class="existing-file">
                        <div class="file-info">
                            <i class="fas fa-file-alt" style="color: #17a2b8;"></i>
                            <div>
                                <strong>Existing Documents:</strong>
                                {% for att in attachments %}
                                {% if att.document_category in ['Business Registration', 'Tax Certificate', 'Financial Statements', 'Bank Statements', 'Director ID', 'Business Address Proof', 'Collateral Documents', 'Collateral Proof', 'Collateral Photos'] %}
                                <div>{{ att.document_category }} - {{ att.file_name }}</div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="upload-slot">
                        <div class="slot-title"><i class="fas fa-file-alt"></i> 1. Update Business Registration Certificate</div>
                        <div class="slot-desc">Upload certified copy of business registration. Leave empty to keep current.</div>
                        <input type="file" name="bus-reg-cert" id="bus-reg-cert" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="upload-slot">
                        <div class="slot-title"><i class="fas fa-file-invoice-dollar"></i> 2. Update Tax Compliance Certificate</div>
                        <div class="slot-desc">ZRA Tax Compliance Certificate. Leave empty to keep current.</div>
                        <input type="file" name="bus-tax-cert" id="bus-tax-cert" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="upload-slot">
                        <div class="slot-title"><i class="fas fa-chart-line"></i> 3. Update Audited Financials <span class="optional-badge">Optional</span></div>
                        <div class="slot-desc">Audited financial statements for last 12 months. Leave empty to keep current.</div>
                        <input type="file" name="bus-financials" id="bus-financials" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="upload-slot">
                        <div class="slot-title"><i class="fas fa-bank"></i> 4. Update Bank Statements</div>
                        <div class="slot-desc">Business bank account statements for last 6 months. Leave empty to keep current.</div>
                        <input type="file" name="bus-bank-stmts" id="bus-bank-stmts" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="upload-slot">
                        <div class="slot-title"><i class="fas fa-id-card"></i> 5. Update Directors' Identification</div>
                        <div class="slot-desc">NRC/Passport copies of all directors. Leave empty to keep current.</div>
                        <input type="file" name="bus-directors-id" id="bus-directors-id" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png" multiple>
                    </div>
                    <div class="upload-slot">
                        <div class="slot-title"><i class="fas fa-home"></i> 6. Update Proof of Business Address</div>
                        <div class="slot-desc">Utility bill or lease agreement for business premises. Leave empty to keep current.</div>
                        <input type="file" name="bus-address-proof" id="bus-address-proof" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-back" onclick="showBusStep(3)">Back</button>
                        <button type="button" class="btn btn-next" onclick="validateAndProceed('bus',4,5)">Next: Agreement <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="form-card" id="bus-step5">
                <div class="card-header"><h2><i class="fas fa-handshake"></i> Finalize Agreement</h2></div>
                <div class="card-body">
                    <label>Authorized Signatory Signature <span class="required">*</span></label>
                    <div class="sig-toggle">
                        <div class="sig-method active" onclick="toggleBusSig('draw')">Draw New Signature</div>
                        <div class="sig-method" onclick="toggleBusSig('upload')">Upload New Signature</div>
                    </div>
                    <div id="sig-draw-box-bus" class="active">
                        <canvas id="sig-canvas-bus"></canvas>
                        <button type="button" class="btn btn-back" style="margin-top:5px;padding:5px 10px" onclick="clearBusSig()">Clear</button>
                        <input type="hidden" name="bus-signature-data" id="bus-signature-data">
                    </div>
                    <div id="sig-upload-box-bus">
                        <label>Upload New Signature Image</label>
                        <input type="file" name="bus-sig-upload" id="bus-sig-upload" class="form-control" accept=".png,.jpg,.jpeg">
                    </div>
                    
                    <div class="existing-file" style="margin-top: 20px;">
                        <div class="file-info">
                            <i class="fas fa-signature" style="color: #6c757d;"></i>
                            <div>
                                <strong>Existing Signature:</strong>
                                <div>Keep current signature if you don't draw/upload a new one</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top:20px">
                        <label style="font-weight:normal;font-size:13px">
                            <input type="checkbox" name="bus-agreement" id="bus-agreement" required> 
                            I certify that I am an authorized signatory and agree to the updated business loan terms.
                        </label>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-back" onclick="showBusStep(4)">Back</button>
                        <button type="submit" class="btn btn-next" style="background:var(--teal);color:#fff">Update Application</button>
                    </div>
                </div>
            </div>
        </form>
        {% endif %}
    </main>
   <script>
    let loanType='{{ loan.loan_type }}',indSignaturePad,busSignaturePad;

    // 1. RATE MAPPING TABLE (Matches your specific rules)
    const INTEREST_RATES = {
        6:  0.15,  // 1 week
        8:  0.20,  // 2 weeks
        14: 0.35,  // 3 weeks
        16: 0.40,  // 4 weeks (1 Month)
        22: 0.55,  // 5 weeks
        24: 0.60,  // 6 weeks
        30: 0.75,  // 7 weeks
        32: 0.80,  // 8 weeks (2 Months)
        38: 0.95,  // 2 Months 1 Week
        40: 1.00,  // 2 Months 2 Weeks
        46: 1.15,  // 2 Months 3 Weeks
        48: 1.20   // 3 Months
    };

    // 2. HELPER TO GET NUMBER OF WEEKS FOR INSTALLMENT CALCULATION
    function getWeekCount(periodValue) {
        const keys = [6, 8, 14, 16, 22, 24, 30, 32, 38, 40, 46, 48];
        const index = keys.indexOf(parseInt(periodValue));
        return index >= 0 ? index + 1 : 1; // Index 0 is 1 week, Index 1 is 2 weeks, etc.
    }

    // 3. Function to navigate to any step
    function goToStep(loanType, stepNumber) {
        if (loanType === 'ind') {
            showIndStep(stepNumber);
        } else if (loanType === 'bus') {
            showBusStep(stepNumber);
        }
    }

    // Auto-start with correct form
    document.addEventListener('DOMContentLoaded', function() {
        if(loanType === 'personal') {
            document.getElementById('individualForm').style.display = 'block';
            document.getElementById('businessForm').style.display = 'none';
            showIndStep(1);
            setTimeout(() => {
                updateIndCalc();
            }, 100);
        } else {
            document.getElementById('individualForm').style.display = 'none';
            document.getElementById('businessForm').style.display = 'block';
            showBusStep(1);
            setTimeout(() => {
                updateBusCalc();
            }, 100);
        }
        
        // Initialize signature pads
        const indCanvas = document.getElementById('sig-canvas-ind');
        if(indCanvas) {
            indCanvas.width = indCanvas.offsetWidth;
            indCanvas.height = 150;
            indSignaturePad = new SignaturePad(indCanvas);
        }
        
        const busCanvas = document.getElementById('sig-canvas-bus');
        if(busCanvas) {
            busCanvas.width = busCanvas.offsetWidth;
            busCanvas.height = 150;
            busSignaturePad = new SignaturePad(busCanvas);
        }
        
        // Hide backend message after timeout
        let e = document.getElementById('backend-message');
        e && setTimeout(() => { e.style.display = 'none'; }, 10000);
    });

    function showIndStep(step) {
        // Hide all form cards
        document.querySelectorAll('#individualForm .form-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Update step indicators
        document.querySelectorAll('#individualForm .step').forEach((stepEl, index) => {
            stepEl.classList.remove('active', 'completed');
            if (index + 1 < step) {
                stepEl.classList.add('completed');
            } else if (index + 1 === step) {
                stepEl.classList.add('active');
            }
        });
        
        // Show the selected step
        document.getElementById('ind-step' + step).classList.add('active');
        
        // Update calculator when on step 1
        if (step === 1) {
            setTimeout(() => {
                updateIndCalc();
            }, 100);
        }
        
        window.scrollTo(0,0);
    }

    // UPDATED INDIVIDUAL CALCULATOR - EXACTLY LIKE LOAN APPLICATION
    function updateIndCalc() {
        const amountInput = document.getElementById('ind-amt');
        const periodSelect = document.getElementById('ind-period');
        
        if (!amountInput || !periodSelect) return;
        
        let loanAmount = parseFloat(amountInput.value) || 0;
        let periodValue = parseInt(periodSelect.value) || 6;
        let rate = INTEREST_RATES[periodValue] || 0;
        let interest = loanAmount * rate;
        let total = loanAmount + interest;
        let weeks = getWeekCount(periodValue);
        let installment = total / weeks;
        
        const totalRepayEl = document.getElementById('ind-totalRepay');
        const weeklyRepayEl = document.getElementById('ind-weeklyRepay');
        const interestRateEl = document.getElementById('ind-interestRate');
        
        if (totalRepayEl) {
            totalRepayEl.innerText = "Total Repayment: K " + total.toLocaleString(void 0, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        if (weeklyRepayEl) {
            weeklyRepayEl.innerText = "Weekly: K " + installment.toLocaleString(void 0, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        if (interestRateEl) {
            interestRateEl.innerText = "Interest Rate: " + (rate * 100).toFixed(0) + "%";
        }
    }

    function showBusStep(step) {
        // Hide all form cards
        document.querySelectorAll('#businessForm .form-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Update step indicators
        document.querySelectorAll('#businessForm .step').forEach((stepEl, index) => {
            stepEl.classList.remove('active', 'completed');
            if (index + 1 < step) {
                stepEl.classList.add('completed');
            } else if (index + 1 === step) {
                stepEl.classList.add('active');
            }
        });
        
        // Show the selected step
        document.getElementById('bus-step' + step).classList.add('active');
        
        // Update calculator when on step 2
        if (step === 2) {
            setTimeout(() => {
                updateBusCalc();
            }, 100);
        }
        
        window.scrollTo(0,0);
    }

    // UPDATED BUSINESS CALCULATOR - EXACTLY LIKE LOAN APPLICATION
    function updateBusCalc() {
        const amountInput = document.getElementById('bus-amt');
        const periodSelect = document.getElementById('bus-period');
        
        if (!amountInput || !periodSelect) return;
        
        let loanAmount = parseFloat(amountInput.value) || 0;
        let periodValue = parseInt(periodSelect.value) || 6;
        let rate = INTEREST_RATES[periodValue] || 0;
        let interest = loanAmount * rate;
        let total = loanAmount + interest;
        let weeks = getWeekCount(periodValue);
        let installment = total / weeks;
        
        const totalRepayEl = document.getElementById('bus-totalRepay');
        const weeklyRepayEl = document.getElementById('bus-weeklyRepay');
        const interestRateEl = document.getElementById('bus-interestRate');
        
        if (totalRepayEl) {
            totalRepayEl.innerText = "Total Repayment: K " + total.toLocaleString(void 0, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        if (weeklyRepayEl) {
            weeklyRepayEl.innerText = "Weekly: K " + installment.toLocaleString(void 0, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        if (interestRateEl) {
            interestRateEl.innerText = "Interest Rate: " + (rate * 100).toFixed(0) + "%";
        }
    }

    function toggleSig(method) {
        document.querySelectorAll('.sig-method').forEach(el => el.classList.remove('active'));
        document.getElementById('sig-draw-box').classList.remove('active');
        document.getElementById('sig-upload-box').classList.remove('active');
        
        if (method === 'draw') {
            document.getElementById('sig-draw-box').classList.add('active');
            event.target.classList.add('active');
            if (!indSignaturePad) {
                const canvas = document.getElementById('sig-canvas-ind');
                canvas.width = canvas.offsetWidth;
                indSignaturePad = new SignaturePad(canvas);
            }
        } else {
            document.getElementById('sig-upload-box').classList.add('active');
            event.target.classList.add('active');
        }
    }
    
    function toggleBusSig(method) {
        document.querySelectorAll('.sig-method').forEach(el => el.classList.remove('active'));
        document.getElementById('sig-draw-box-bus').classList.remove('active');
        document.getElementById('sig-upload-box-bus').classList.remove('active');
        
        if (method === 'draw') {
            document.getElementById('sig-draw-box-bus').classList.add('active');
            event.target.classList.add('active');
            if (!busSignaturePad) {
                const canvas = document.getElementById('sig-canvas-bus');
                canvas.width = canvas.offsetWidth;
                busSignaturePad = new SignaturePad(canvas);
            }
        } else {
            document.getElementById('sig-upload-box-bus').classList.add('active');
            event.target.classList.add('active');
        }
    }
    
    function clearIndSig() {
        indSignaturePad && indSignaturePad.clear();
    }
    
    function clearBusSig() {
        busSignaturePad && busSignaturePad.clear();
    }
    
    function validateAndProceed(loanType, currentStep, nextStep) {
        if (validateStep(loanType, currentStep)) {
            if (loanType === 'ind') {
                showIndStep(nextStep);
            } else {
                showBusStep(nextStep);
            }
        }
    }
    
    function validateStep(loanType, step) {
        return loanType === 'ind' ? validateIndStep(step) : validateBusStep(step);
    }
    
    function validateIndStep(step) {
        if (step === 1) {
            let amount = document.getElementById('ind-amt').value;
            let purpose = document.getElementById('ind-purpose').value;
            let period = document.getElementById('ind-period').value;
            
            if (!amount || !purpose || !period) {
                alert("Please fill all required fields in Loan Details.");
                return false;
            }
            if (parseFloat(amount) < 100) {
                alert("Minimum loan amount is K100.");
                return false;
            }
        } else if (step === 2) {
            // Collateral step - description is optional in edit mode
        } else if (step === 3) {
            let name = document.getElementById('ind-name').value;
            let dob = document.getElementById('ind-dob').value;
            let nrc = document.getElementById('ind-nrc').value;
            let email = document.getElementById('ind-email').value;
            let phone = document.getElementById('ind-phone').value;
            let address = document.getElementById('ind-address').value;
            
            if (!name || !dob || !nrc || !email || !phone || !address) {
                alert("Please fill all required personal information fields.");
                return false;
            }
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                alert("Please enter a valid email address.");
                return false;
            }
            if (!/^\d{6}\/\d{2}\/\d{1}$/.test(nrc)) {
                alert("Please enter NRC in format: 123456/78/9");
                return false;
            }
        }
        return true;
    }
    
    function validateBusStep(step) {
        if (step === 1) {
            let businessName = document.getElementById('bus-name').value;
            let regNumber = document.getElementById('bus-reg').value;
            let contactName = document.getElementById('bus-contact-name').value;
            let contactEmail = document.getElementById('bus-contact-email').value;
            let contactPhone = document.getElementById('bus-contact-phone').value;
            
            if (!businessName || !regNumber || !contactName || !contactEmail || !contactPhone) {
                alert("Please fill all required business details.");
                return false;
            }
            if (!/^\S+@\S+\.\S+$/.test(contactEmail)) {
                alert("Please enter a valid email address for contact person.");
                return false;
            }
        } else if (step === 2) {
            let amount = document.getElementById('bus-amt').value;
            let purpose = document.getElementById('bus-purpose').value;
            let reason = document.getElementById('bus-reason').value;
            let period = document.getElementById('bus-period').value;
            
            if (!amount || !purpose || !reason || !period) {
                alert("Please fill all required loan request fields.");
                return false;
            }
            if (parseFloat(amount) < 1000) {
                alert("Minimum business loan amount is K1,000.");
                return false;
            }
        } else if (step === 3) {
            let collateralType = document.getElementById('bus-collateral-type').value;
            let collateralDesc = document.getElementById('bus-collateral-desc').value;
            let collateralValue = document.getElementById('bus-collateral-value').value;
            
            if (!collateralType || !collateralDesc || !collateralValue) {
                alert("Please fill all required collateral information.");
                return false;
            }
        }
        return true;
    }
    
    // Form submission handlers - modified for edit mode
    document.getElementById('individualForm')?.addEventListener('submit', function(event) {
        let sigMethod = document.querySelector('#ind-step4 .sig-method.active')?.textContent.trim();
        
        if (sigMethod === 'Draw New Signature') {
            if (indSignaturePad && !indSignaturePad.isEmpty()) {
                document.getElementById('ind-signature-data').value = indSignaturePad.toDataURL();
            }
        } else if (document.getElementById('ind-sig-upload').files[0]) {
            // Signature uploaded, will be processed by backend
        }
        
        if (!document.getElementById('ind-agreement').checked) {
            alert("Please agree to the terms and conditions.");
            event.preventDefault();
            return false;
        }
        
        showAlert('Updating your personal loan application...', 'info');
        return true;
    });
    
    document.getElementById('businessForm')?.addEventListener('submit', function(event) {
        let sigMethod = document.querySelector('#bus-step5 .sig-method.active')?.textContent.trim();
        
        if (sigMethod === 'Draw New Signature') {
            if (busSignaturePad && !busSignaturePad.isEmpty()) {
                document.getElementById('bus-signature-data').value = busSignaturePad.toDataURL();
            }
        } else if (document.getElementById('bus-sig-upload').files[0]) {
            // Signature uploaded, will be processed by backend
        }
        
        if (!document.getElementById('bus-agreement').checked) {
            alert("Please agree to the terms and conditions.");
            event.preventDefault();
            return false;
        }
        
        showAlert('Updating your business loan application...', 'info');
        return true;
    });
    
    function showAlert(message, type) {
        document.querySelectorAll('.alert').forEach(alert => alert.remove());
        let alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = `${message}<button class="alert-close" onclick="this.parentElement.style.display='none'">Ã—</button>`;
        document.querySelector('.main-content').insertBefore(alertDiv, document.querySelector('.main-content').firstChild);
        if (type === 'info') {
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.display = 'none';
                }
            }, 10000);
        }
    }
</script>
</body>
</html>
{% endblock %}