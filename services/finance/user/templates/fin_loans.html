{% extends "fin_base.html" %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tukakombe Loans | Smart Application</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
        :root{--navy:#1a2a40;--navy-dark:#0d1621;--navy-light:#2c3e5a;--lime:#a2d242;--lime-light:#c5e86c;--lime-dark:#8eb936;--teal:#4ecdc4;--white:#fff;--off-white:#f8fafc;--cream:#fef6e4;--transition:all .3s ease}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}body{background:var(--off-white);color:var(--navy-dark);line-height:1.6;padding-bottom:50px}
        .header{background:var(--navy);color:var(--white);padding:15px 0;position:sticky;top:0;z-index:1000}.header-container{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 20px}.logo{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:800}.logo span{color:var(--lime)}
        .main-content{max-width:900px;margin:30px auto;padding:0 20px}
        .loan-type-selector{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:30px 0}.type-card{background:#fff;border-radius:16px;padding:40px 30px;text-align:center;cursor:pointer;border:2px solid #e2e8f0;transition:var(--transition)}.type-card:hover{transform:translateY(-5px);border-color:var(--teal);box-shadow:0 10px 25px rgba(0,0,0,.1)}.type-card.active{border-color:var(--lime);background:rgba(162,210,66,.05)}.type-icon{font-size:48px;margin-bottom:20px;color:var(--navy-light)}.type-title{font-size:24px;font-weight:700;margin-bottom:10px;color:var(--navy)}.type-desc{color:#64748b;font-size:14px}
        .steps-container{display:flex;justify-content:space-between;margin-bottom:30px;position:relative}.steps-container::before{content:'';position:absolute;top:20px;left:0;width:100%;height:2px;background:#cbd5e1;z-index:1}.step{width:40px;height:40px;border-radius:50%;background:#fff;border:2px solid #cbd5e1;display:flex;align-items:center;justify-content:center;z-index:2;font-weight:700}.step.active{border-color:var(--lime);background:var(--lime);color:var(--navy)}.step.completed{background:var(--teal);border-color:var(--teal);color:#fff}
        .form-card{background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.05);overflow:hidden;display:none}.form-card.active{display:block;animation:fadeIn .4s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .card-header{background:var(--navy);color:#fff;padding:20px 30px}.card-body{padding:30px}
        .form-group{margin-bottom:20px}label{display:block;font-weight:600;margin-bottom:8px;color:var(--navy)}.form-control{width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:8px;font-size:15px}.required{color:#e74c3c}
        .category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:25px}.category-btn{padding:15px;border:2px solid #e2e8f0;border-radius:12px;text-align:center;cursor:pointer;transition:var(--transition);background:#fff}.category-btn i{display:block;font-size:24px;margin-bottom:8px;color:var(--navy-light)}.category-btn:hover{border-color:var(--teal)}.category-btn.active{border-color:var(--lime);background:rgba(162,210,66,.05)}
        .items-container{display:none;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;padding:15px;background:var(--off-white);border-radius:12px;margin-bottom:20px}.items-container.active{display:grid}.item-check{display:flex;align-items:center;gap:10px;padding:10px;background:#fff;border:1px solid #eee;border-radius:8px}
        .upload-slot{border:2px dashed #cbd5e1;padding:15px;border-radius:10px;margin-bottom:15px;transition:var(--transition)}.upload-slot:hover{border-color:var(--teal);background:rgba(78,205,196,.02)}.slot-title{font-weight:700;display:flex;align-items:center;gap:8px;font-size:14px}.slot-desc{font-size:12px;color:#64748b;margin-top:4px}.optional-badge{background:#f0f0f0;color:#666;padding:2px 8px;border-radius:4px;font-size:10px;margin-left:8px}
        .sig-toggle{display:flex;gap:10px;margin-bottom:15px}.sig-method{flex:1;padding:10px;text-align:center;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:14px}.sig-method.active{background:var(--navy);color:#fff;border-color:var(--navy)}#sig-upload-box,#sig-draw-box{display:none}#sig-upload-box.active,#sig-draw-box.active{display:block}canvas{border:1px solid #ddd;width:100%;height:150px;background:#fff;border-radius:8px}
        .btn-group{display:flex;justify-content:space-between;margin-top:30px}.btn{padding:12px 25px;border-radius:8px;font-weight:700;cursor:pointer;border:none;transition:var(--transition)}.btn-next{background:var(--lime);color:var(--navy)}.btn-back{background:transparent;border:1px solid #cbd5e1}
        .calc-summary{background:var(--cream);padding:15px;border-radius:10px;border-left:4px solid var(--lime);margin-top:15px}
        .other-input-container{display:none;margin-top:15px}.other-input-container.active{display:block}
        .btn-back-type{background:#64748b;color:#fff;border:none}.btn-back-type:hover{background:#475569}
        .alert{padding:15px;border-radius:8px;margin:20px 0;display:block;animation:fadeIn .3s ease}.alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.alert-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.alert-info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}.alert-close{float:right;background:0;border:0;font-size:20px;cursor:pointer;color:inherit}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">Tuka<span>kombe</span> Loans</div>
            <div style="font-size:14px"><i class="fas fa-phone"></i> +260 967651727</div>
        </div>
    </header>
    <main class="main-content">
        {% with messages=get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category,message in messages %}
                    <div class="alert alert-{{category if category!='message' else 'success'}}" id="backend-message">{{message}}<button class="alert-close" onclick="this.parentElement.style.display='none'">×</button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <div class="form-card active" id="step0">
            <div class="card-header"><h2><i class="fas fa-hand-holding-usd"></i> Select Loan Type</h2></div>
            <div class="card-body">
                <p style="margin-bottom:30px;color:#64748b;text-align:center">Choose the type of loan that best fits your needs</p>
                <div class="loan-type-selector">
                    <div class="type-card" onclick="selectLoanType('personal',this)"><div class="type-icon"><i class="fas fa-user"></i></div><div class="type-title">Personal Loan</div><div class="type-desc">For individual borrowers. Quick approval, flexible terms.</div></div>
                    <div class="type-card" onclick="selectLoanType('business',this)"><div class="type-icon"><i class="fas fa-building"></i></div><div class="type-title">Business Loan</div><div class="type-desc">For registered businesses. Higher amounts, business terms.</div></div>
                </div>
                <div class="btn-group" style="justify-content:center;margin-top:40px">
                    <button type="button" class="btn btn-next" onclick="startApplication()" id="startBtn" disabled>Start Application <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>
        <form id="individualForm" method="POST" action="{{url_for('finance.loans')}}" enctype="multipart/form-data" style="display:none">
            <input type="hidden" name="loan_type" id="loan_type_ind" value="">
            <div class="steps-container"><div class="step active" id="ind-dot1">1</div><div class="step" id="ind-dot2">2</div><div class="step" id="ind-dot3">3</div><div class="step" id="ind-dot4">4</div></div>
            <div class="form-card active" id="ind-step1">
                <div class="card-header"><h2><i class="fas fa-money-bill-wave"></i> Loan Details</h2></div>
                <div class="card-body">
                    <div class="form-group"><label>Loan Amount (ZMW) <span class="required">*</span></label><input type="number" name="ind-amt" id="ind-amt" class="form-control" placeholder="e.g., 5000" required min="100" oninput="updateIndCalc()"></div>
                    <div class="form-group"><label>Purpose of Loan <span class="required">*</span></label><select name="ind-purpose" id="ind-purpose" class="form-control" required><option value="">Select purpose</option><option value="education">Education Fees</option><option value="medical">Medical Expenses</option><option value="home">Home Improvement</option><option value="vehicle">Vehicle Purchase</option><option value="debt">Debt Consolidation</option><option value="other">Other</option></select></div>
                    <div class="form-group"><label>Repayment Period<span class="required">*</span></label><select name="ind-period" id="ind-period" class="form-control" required onchange="updateIndCalc()"><option value="6">1 Week</option><option value="8">2 Weeks</option><option value="14">3 Weeks</option><option value="16">1 Month</option><option value="22">5 Weeks</option><option value="24">6 Weeks</option><option value="30">7 Weeks</option><option value="32">2 Months</option><option value="48">3 Months</option></select></div>
                    <div class="calc-summary"><div id="ind-totalRepay">Total Repayment: K 0.00</div><div id="ind-monthlyRepay" style="display:none">Monthly: K 0.00</div></div>
                    <div class="btn-group"><button type="button" class="btn btn-back btn-back-type" onclick="goBackToType()"><i class="fas fa-arrow-left"></i> Back to Loan Type</button><button type="button" class="btn btn-next" onclick="validateAndProceed('ind',1,2)">Next: Collateral <i class="fas fa-arrow-right"></i></button></div>
                </div>
            </div>
            <div class="form-card" id="ind-step2">
                <div class="card-header"><h2><i class="fas fa-boxes"></i> Collateral Selection</h2></div>
                <div class="card-body">
                    <label>Select Category <span class="required">*</span></label>
                    <div class="category-grid">
                        <div class="category-btn" onclick="showItems('electronics',this)"><i class="fas fa-laptop"></i> Electronics</div>
                        <div class="category-btn" onclick="showItems('appliances',this)"><i class="fas fa-blender"></i> Appliances</div>
                        <div class="category-btn" onclick="showItems('vehicles',this)"><i class="fas fa-car"></i> Vehicles</div>
                        <div class="category-btn" onclick="showItems('other',this)"><i class="fas fa-ellipsis-h"></i> Other</div>
                    </div>
                    <div id="electronics" class="items-container"><div class="item-check"><input type="checkbox" name="collateral" value="laptop"> Laptop</div><div class="item-check"><input type="checkbox" name="collateral" value="smartphone"> Smartphone</div><div class="item-check"><input type="checkbox" name="collateral" value="smart-tv"> Smart TV</div><div class="item-check"><input type="checkbox" name="collateral" value="gaming-console"> Gaming Console</div><div class="item-check"><input type="checkbox" name="collateral" value="printer"> Printer</div><div class="item-check"><input type="checkbox" name="collateral" value="projector"> Projector</div><div class="item-check"><input type="checkbox" name="collateral" value="digital-camera"> Digital Camera</div><div class="item-check"><input type="checkbox" name="collateral" value="studio-equipment"> Studio Equipment</div><div class="item-check"><input type="checkbox" name="collateral" value="smart-watch"> Smart Watch</div></div>
                    <div id="appliances" class="items-container"><div class="item-check"><input type="checkbox" name="collateral" value="fridge"> Fridge/Freezer</div><div class="item-check"><input type="checkbox" name="collateral" value="microwave"> Microwave</div><div class="item-check"><input type="checkbox" name="collateral" value="washing-machine"> Washing Machine</div><div class="item-check"><input type="checkbox" name="collateral" value="generator"> Generator</div><div class="item-check"><input type="checkbox" name="collateral" value="air-conditioner"> Air Conditioner</div></div>
                    <div id="vehicles" class="items-container"><div class="item-check"><input type="checkbox" name="collateral" value="motorcycle"> Motorcycle</div><div class="item-check"><input type="checkbox" name="collateral" value="vehicle"> Vehicle</div><div class="item-check"><input type="checkbox" name="collateral" value="bicycle"> Bicycle (High-end)</div></div>
                    <div id="other" class="items-container"><div class="item-check"><input type="checkbox" id="other-checkbox" name="collateral_other_check"> Other (specify below)</div></div>
                    <div class="other-input-container" id="other-input"><label>Describe Other Collateral <span class="required">*</span></label><input type="text" class="form-control" id="other-description" placeholder="Describe your collateral item..."><input type="hidden" name="other_collateral" id="other-description-hidden"></div>
                    <div class="form-group"><label>Item Description & Condition <span class="required">*</span></label><textarea name="ind-description" id="ind-description" class="form-control" rows="3" placeholder="Brand, Model, Serial Number, Working condition..." required></textarea></div>
                    <div class="form-group"><label>Upload Photos of Collateral Items <span class="required">*</span></label><div class="upload-slot" style="margin-bottom:10px"><div class="slot-title"><i class="fas fa-images"></i> Collateral Images</div><div class="slot-desc">Upload clear photos of each collateral item (front, back, sides). Multiple items can be uploaded separately.</div><input type="file" name="ind-collateral-photos" id="ind-collateral-photos" class="form-control" style="margin-top:10px" accept=".jpg,.jpeg,.png,.heic" multiple required></div></div>
                    <div class="form-group"><label>Upload Serial Number/ID Proof (Optional)</label><div class="upload-slot"><div class="slot-title"><i class="fas fa-barcode"></i> Serial Number/ID Documents <span class="optional-badge">Optional</span></div><div class="slot-desc">Upload photos showing serial numbers, model numbers, or any identification marks</div><input type="file" name="ind-serial-photos" id="ind-serial-photos" class="form-control" style="margin-top:10px" accept=".jpg,.jpeg,.png,.heic,.pdf" multiple></div></div>
                    <div class="btn-group"><button type="button" class="btn btn-back" onclick="showIndStep(1)">Back</button><button type="button" class="btn btn-next" onclick="validateAndProceed('ind',2,3)">Next: KYC Documents <i class="fas fa-arrow-right"></i></button></div>
                </div>
            </div>
            <div class="form-card" id="ind-step3">
                <div class="card-header"><h2><i class="fas fa-id-card"></i> Personal & KYC Documents</h2></div>
                <div class="card-body">
                    <div class="form-group"><label>Full Name <span class="required">*</span></label><input type="text" name="ind-name" id="ind-name" class="form-control" required></div>
                    <div class="form-group"><label>Date of Birth <span class="required">*</span></label><input type="date" name="ind-dob" id="ind-dob" class="form-control" required></div>
                    <div class="form-group"><label>NRC Number <span class="required">*</span></label><input type="text" name="ind-nrc" id="ind-nrc" class="form-control" placeholder="e.g., 123456/78/9" required pattern="\d{6}\/\d{2}\/\d{1}"></div>
                    <div class="form-group"><label>Email <span class="required">*</span></label><input type="email" name="ind-email" id="ind-email" class="form-control" required></div>
                    <div class="form-group"><label>Phone Number <span class="required">*</span></label><input type="tel" name="ind-phone" id="ind-phone" class="form-control" required></div>
                    <div class="form-group"><label>Residential Address <span class="required">*</span></label><textarea name="ind-address" id="ind-address" class="form-control" rows="2" required></textarea></div>
                    <div class="upload-slot"><div class="slot-title"><i class="fas fa-passport"></i> 1. Proof of Identity <span class="required">*</span></div><div class="slot-desc">Upload NRC, Passport, or Driver's License (PDF, JPG, PNG up to 5MB)</div><input type="file" name="ind-identity" id="ind-identity" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png" required></div>
                    <div class="upload-slot"><div class="slot-title"><i class="fas fa-home"></i> 2. Proof of Residence <span class="required">*</span></div><div class="slot-desc">Utility bill, Rent agreement, or Utility bill + Landlord agreement</div><input type="file" name="ind-residence" id="ind-residence" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png" required></div>
                    <div class="upload-slot"><div class="slot-title"><i class="fas fa-file-invoice"></i> 3. Proof of Income <span class="optional-badge">Optional</span></div><div class="slot-desc">Recent payslips (last 3 months) or bank statements</div><input type="file" name="ind-income" id="ind-income" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png"></div>
                    <div class="btn-group"><button type="button" class="btn btn-back" onclick="showIndStep(2)">Back</button><button type="button" class="btn btn-next" onclick="validateAndProceed('ind',3,4)">Next: Agreement <i class="fas fa-arrow-right"></i></button></div>
                </div>
            </div>
            <div class="form-card" id="ind-step4">
                <div class="card-header"><h2><i class="fas fa-pen-fancy"></i> Finalize Agreement</h2></div>
                <div class="card-body">
                    <label>How would you like to sign? <span class="required">*</span></label>
                    <div class="sig-toggle"><div class="sig-method active" onclick="toggleSig('draw')">Draw Signature</div><div class="sig-method" onclick="toggleSig('upload')">Upload Signature</div></div>
                    <div id="sig-draw-box" class="active"><canvas id="sig-canvas-ind"></canvas><button type="button" class="btn btn-back" style="margin-top:5px;padding:5px 10px" onclick="clearIndSig()">Clear</button><input type="hidden" name="ind-signature-data" id="ind-signature-data"></div>
                    <div id="sig-upload-box"><label>Upload Signature Image <span class="required">*</span></label><input type="file" name="ind-sig-upload" id="ind-sig-upload" class="form-control" accept=".png,.jpg,.jpeg"></div>
                    <div class="form-group" style="margin-top:20px"><label style="font-weight:normal;font-size:13px"><input type="checkbox" name="ind-agreement" id="ind-agreement" required> I agree that the information provided is true and I accept the terms of Tukakombe Loans.</label></div>
                    <div class="btn-group"><button type="button" class="btn btn-back" onclick="showIndStep(3)">Back</button><button type="submit" class="btn btn-next" style="background:var(--teal);color:#fff">Submit Application</button></div>
                </div>
            </div>
        </form>
        <form id="businessForm" method="POST" action="{{url_for('finance.loans')}}" enctype="multipart/form-data" style="display:none">
            <input type="hidden" name="loan_type" id="loan_type_bus" value="">
            <div class="steps-container"><div class="step active" id="bus-dot1">1</div><div class="step" id="bus-dot2">2</div><div class="step" id="bus-dot3">3</div><div class="step" id="bus-dot4">4</div><div class="step" id="bus-dot5">5</div></div>
            <div class="form-card active" id="bus-step1">
                <div class="card-header"><h2><i class="fas fa-building"></i> Business Details</h2></div>
                <div class="card-body">
                    <div class="form-group"><label>Business Name <span class="required">*</span></label><input type="text" name="bus-name" id="bus-name" class="form-control" required></div>
                    <div class="form-group"><label>Business Registration Number <span class="required">*</span></label><input type="text" name="bus-reg" id="bus-reg" class="form-control" required></div>
                    <div class="form-group"><label>Contact Person Name <span class="required">*</span></label><input type="text" name="bus-contact-name" id="bus-contact-name" class="form-control" required></div>
                    <div class="form-group"><label>Contact Person Email <span class="required">*</span></label><input type="email" name="bus-contact-email" id="bus-contact-email" class="form-control" required></div>
                    <div class="form-group"><label>Contact Person Phone <span class="required">*</span></label><input type="tel" name="bus-contact-phone" id="bus-contact-phone" class="form-control" required></div>
                    <div class="form-group"><label>Contact Person Position</label><input type="text" name="bus-contact-position" id="bus-contact-position" class="form-control" placeholder="e.g., Director, Manager"></div>
                    <div class="btn-group"><button type="button" class="btn btn-back btn-back-type" onclick="goBackToType()"><i class="fas fa-arrow-left"></i> Back to Loan Type</button><button type="button" class="btn btn-next" onclick="validateAndProceed('bus',1,2)">Next: Loan Request <i class="fas fa-arrow-right"></i></button></div>
                </div>
            </div>
            <div class="form-card" id="bus-step2">
                <div class="card-header"><h2><i class="fas fa-money-bill-wave"></i> Loan Request</h2></div>
                <div class="card-body">
                    <div class="form-group"><label>Loan Amount Required (ZMW) <span class="required">*</span></label><input type="number" name="bus-amt" id="bus-amt" class="form-control" placeholder="e.g., 50000" required min="1000" oninput="updateBusCalc()"></div>
                    <div class="form-group"><label>Reason for Borrowing <span class="required">*</span></label><select name="bus-purpose" id="bus-purpose" class="form-control" required><option value="">Select reason</option><option value="expansion">Business Expansion</option><option value="inventory">Inventory Purchase</option><option value="equipment">Equipment Purchase</option><option value="working-capital">Working Capital</option><option value="renovation">Premises Renovation</option><option value="other">Other</option></select></div>
                    <div class="form-group"><label>Detailed Reason <span class="required">*</span></label><textarea name="bus-reason" id="bus-reason" class="form-control" rows="4" placeholder="Provide detailed explanation of how the loan will be used..." required></textarea></div>
                    <div class="form-group"><label>Repayment Period<span class="required">*</span></label><select name="bus-period" id="bus-period" class="form-control" required onchange="updateBusCalc()"><option value="6">1 Week</option><option value="8">2 Weeks</option><option value="14">3 Weeks</option><option value="16">1 Month</option><option value="22">5 Weeks</option><option value="24">6 Weeks</option><option value="30">7 Weeks</option><option value="32">2 Months</option><option value="48">3 Months</option></select></div>
                    <div class="calc-summary"><div id="bus-totalRepay">Total Repayment: K 0.00</div><div id="bus-monthlyRepay" style="display:none">Monthly: K 0.00</div></div>
                    <div class="btn-group"><button type="button" class="btn btn-back" onclick="showBusStep(1)">Back</button><button type="button" class="btn btn-next" onclick="validateAndProceed('bus',2,3)">Next: Collateral <i class="fas fa-arrow-right"></i></button></div>
                </div>
            </div>
            <div class="form-card" id="bus-step3">
                <div class="card-header"><h2><i class="fas fa-shield-alt"></i> Collateral & Security</h2></div>
                <div class="card-body">
                    <div class="form-group"><label>Type of Collateral <span class="required">*</span></label><select name="bus-collateral-type" id="bus-collateral-type" class="form-control" required><option value="">Select type</option><option value="property">Commercial Property</option><option value="equipment">Business Equipment</option><option value="inventory">Inventory Stock</option><option value="vehicle">Business Vehicle</option><option value="guarantor">Personal Guarantor</option></select></div>
                    <div class="form-group"><label>Collateral Description <span class="required">*</span></label><textarea name="bus-collateral-desc" id="bus-collateral-desc" class="form-control" rows="4" placeholder="Describe collateral in detail including value, condition, location..." required></textarea></div>
                    <div class="form-group"><label>Estimated Collateral Value (ZMW) <span class="required">*</span></label><input type="number" name="bus-collateral-value" id="bus-collateral-value" class="form-control" required></div>
                    <div class="form-group"><label>Collateral Ownership Proof <span class="required">*</span></label><input type="file" name="bus-collateral-proof" id="bus-collateral-proof" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required><div class="slot-desc">Title deed, purchase receipt, registration documents</div></div>
                    <div class="form-group"><label>Upload Collateral Photos/Documents <span class="required">*</span></label><div class="upload-slot" style="margin-bottom:10px"><div class="slot-title"><i class="fas fa-camera"></i> Collateral Visual Documentation</div><div class="slot-desc">Upload clear photos of collateral (multiple angles for equipment, full view for property/vehicles)</div><input type="file" name="bus-collateral-photos" id="bus-collateral-photos" class="form-control" style="margin-top:10px" accept=".jpg,.jpeg,.png,.heic" multiple required></div></div>
                    <div class="form-group"><label>Additional Collateral Documents</label><div class="upload-slot"><div class="slot-title"><i class="fas fa-file-alt"></i> Supporting Documents <span class="optional-badge">Optional</span></div><div class="slot-desc">Upload any additional documents (valuation reports, maintenance records, insurance papers)</div><input type="file" name="bus-collateral-docs" id="bus-collateral-docs" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple></div></div>
                    <div class="btn-group"><button type="button" class="btn btn-back" onclick="showBusStep(2)">Back</button><button type="button" class="btn btn-next" onclick="validateAndProceed('bus',3,4)">Next: KYC Documents <i class="fas fa-arrow-right"></i></button></div>
                </div>
            </div>
            <div class="form-card" id="bus-step4">
                <div class="card-header"><h2><i class="fas fa-file-contract"></i> Business KYC Documents</h2></div>
                <div class="card-body">
                    <div class="upload-slot"><div class="slot-title"><i class="fas fa-file-alt"></i> 1. Business Registration Certificate <span class="required">*</span></div><div class="slot-desc">Upload certified copy of business registration</div><input type="file" name="bus-reg-cert" id="bus-reg-cert" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png" required></div>
                    <div class="upload-slot"><div class="slot-title"><i class="fas fa-file-invoice-dollar"></i> 2. Tax Compliance Certificate <span class="required">*</span></div><div class="slot-desc">ZRA Tax Compliance Certificate</div><input type="file" name="bus-tax-cert" id="bus-tax-cert" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png" required></div>
                    <div class="upload-slot"><div class="slot-title"><i class="fas fa-chart-line"></i> 3. Audited Financials <span class="optional-badge">Optional</span></div><div class="slot-desc">Audited financial statements for last 12 months</div><input type="file" name="bus-financials" id="bus-financials" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png"></div>
                    <div class="upload-slot"><div class="slot-title"><i class="fas fa-bank"></i> 4. Bank Statements <span class="required">*</span></div><div class="slot-desc">Business bank account statements for last 6 months</div><input type="file" name="bus-bank-stmts" id="bus-bank-stmts" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png"></div>
                    <div class="upload-slot"><div class="slot-title"><i class="fas fa-id-card"></i> 5. Directors' Identification <span class="required">*</span></div><div class="slot-desc">NRC/Passport copies of all directors</div><input type="file" name="bus-directors-id" id="bus-directors-id" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png" required multiple></div>
                    <div class="upload-slot"><div class="slot-title"><i class="fas fa-home"></i> 6. Proof of Business Address <span class="required">*</span></div><div class="slot-desc">Utility bill or lease agreement for business premises</div><input type="file" name="bus-address-proof" id="bus-address-proof" class="form-control" style="margin-top:10px" accept=".pdf,.jpg,.jpeg,.png" required></div>
                    <div class="btn-group"><button type="button" class="btn btn-back" onclick="showBusStep(3)">Back</button><button type="button" class="btn btn-next" onclick="validateAndProceed('bus',4,5)">Next: Agreement <i class="fas fa-arrow-right"></i></button></div>
                </div>
            </div>
            <div class="form-card" id="bus-step5">
                <div class="card-header"><h2><i class="fas fa-handshake"></i> Finalize Agreement</h2></div>
                <div class="card-body">
                    <label>Authorized Signatory Signature <span class="required">*</span></label>
                    <div class="sig-toggle"><div class="sig-method active" onclick="toggleBusSig('draw')">Draw Signature</div><div class="sig-method" onclick="toggleBusSig('upload')">Upload Signature</div></div>
                    <div id="sig-draw-box-bus" class="active"><canvas id="sig-canvas-bus"></canvas><button type="button" class="btn btn-back" style="margin-top:5px;padding:5px 10px" onclick="clearBusSig()">Clear</button><input type="hidden" name="bus-signature-data" id="bus-signature-data"></div>
                    <div id="sig-upload-box-bus"><label>Upload Signature Image <span class="required">*</span></label><input type="file" name="bus-sig-upload" id="bus-sig-upload" class="form-control" accept=".png,.jpg,.jpeg"></div>
                    <div class="form-group" style="margin-top:20px"><label style="font-weight:normal;font-size:13px"><input type="checkbox" name="bus-agreement" id="bus-agreement" required> I certify that I am an authorized signatory and agree to the business loan terms.</label></div>
                    <div class="btn-group"><button type="button" class="btn btn-back" onclick="showBusStep(4)">Back</button><button type="submit" class="btn btn-next" style="background:var(--teal);color:#fff">Submit Application</button></div>
                </div>
            </div>
        </form>
    </main>
   <script>
    let loanType='',indSignaturePad,busSignaturePad;

    // 1. RATE MAPPING TABLE (Matches your specific rules)
    const INTEREST_RATES = {
        6:  0.15,  // 1 week
        8:  0.20,  // 2 weeks
        14: 0.35,  // 3 weeks
        16: 0.40,  // 4 weeks (1 Month)
        22: 0.55,  // 5 weeks
        24: 0.60,  // 6 weeks
        30: 0.75,  // 7 weeks
        32: 0.80,  // 8 weeks (2 Months)
        38: 0.95,  // 2 Months 1 Week
        40: 1.00,  // 2 Months 2 Weeks
        46: 1.15,  // 2 Months 3 Weeks
        48: 1.20   // 3 Months
    };

    // 2. HELPER TO GET NUMBER OF WEEKS FOR INSTALLMENT CALCULATION
    function getWeekCount(periodValue) {
        const keys = [6, 8, 14, 16, 22, 24, 30, 32, 38, 40, 46, 48];
        return keys.indexOf(periodValue) + 1; // Index 0 is 1 week, Index 1 is 2 weeks, etc.
    }

    function selectLoanType(t,e){loanType=t;document.querySelectorAll('.type-card').forEach(t=>{t.classList.remove('active')});e.classList.add('active');'personal'===t?document.getElementById('loan_type_ind').value='personal':'business'===t&&(document.getElementById('loan_type_bus').value='business');document.getElementById('startBtn').disabled=!1}
    function goBackToType(){document.getElementById('step0').style.display='block';document.getElementById('individualForm').style.display='none';document.getElementById('businessForm').style.display='none';loanType='';document.getElementById('startBtn').disabled=!0;document.querySelectorAll('.type-card').forEach(t=>t.classList.remove('active'));document.getElementById('loan_type_ind').value='';document.getElementById('loan_type_bus').value=''}
    function startApplication(){document.getElementById('step0').style.display='none';'personal'===loanType?(document.getElementById('individualForm').style.display='block',document.getElementById('businessForm').style.display='none',showIndStep(1)):'business'===loanType&&(document.getElementById('individualForm').style.display='none',document.getElementById('businessForm').style.display='block',showBusStep(1))}
    function showIndStep(t){document.querySelectorAll('#individualForm .form-card').forEach(e=>e.classList.remove('active'));document.querySelectorAll('#individualForm .step').forEach((e,o)=>{e.classList.remove('active','completed');o+1<t&&e.classList.add('completed');o+1===t&&e.classList.add('active')});document.getElementById('ind-step'+t).classList.add('active');window.scrollTo(0,0)}

    // UPDATED INDIVIDUAL CALCULATOR
    function updateIndCalc(){
        let t=parseFloat(document.getElementById('ind-amt').value)||0;
        let p=parseInt(document.getElementById('ind-period').value)||6;
        let rate = INTEREST_RATES[p] || 0;
        let interest = t * rate;
        let total = t + interest;
        let weeks = getWeekCount(p);
        let installment = total / weeks;
        
        document.getElementById('ind-totalRepay').innerText="Total Repayment: K "+total.toLocaleString(void 0,{minimumFractionDigits:2});
        document.getElementById('ind-monthlyRepay').innerText="Weekly: K "+installment.toLocaleString(void 0,{minimumFractionDigits:2});
    }

    function showBusStep(t){document.querySelectorAll('#businessForm .form-card').forEach(e=>e.classList.remove('active'));document.querySelectorAll('#businessForm .step').forEach((e,o)=>{e.classList.remove('active','completed');o+1<t&&e.classList.add('completed');o+1===t&&e.classList.add('active')});document.getElementById('bus-step'+t).classList.add('active');window.scrollTo(0,0)}

    // UPDATED BUSINESS CALCULATOR
    function updateBusCalc(){
        let t=parseFloat(document.getElementById('bus-amt').value)||0;
        let p=parseInt(document.getElementById('bus-period').value)||6;
        let rate = INTEREST_RATES[p] || 0;
        let interest = t * rate;
        let total = t + interest;
        let weeks = getWeekCount(p);
        let installment = total / weeks;

        document.getElementById('bus-totalRepay').innerText="Total Repayment: K "+total.toLocaleString(void 0,{minimumFractionDigits:2});
        document.getElementById('bus-monthlyRepay').innerText="Weekly: K "+installment.toLocaleString(void 0,{minimumFractionDigits:2});
    }

    function showItems(t,e){document.querySelectorAll('.items-container').forEach(o=>o.classList.remove('active'));document.querySelectorAll('.category-btn').forEach(o=>o.classList.remove('active'));document.getElementById(t).classList.add('active');e.classList.add('active');'other'===t?(document.getElementById('other-input').classList.add('active'),document.getElementById('other-checkbox').checked=!0):(document.getElementById('other-input').classList.remove('active'),document.getElementById('other-checkbox').checked=!1)}
    function toggleSig(t){document.querySelectorAll('.sig-method').forEach(e=>e.classList.remove('active'));document.getElementById('sig-draw-box').classList.remove('active');document.getElementById('sig-upload-box').classList.remove('active');'draw'===t?(document.getElementById('sig-draw-box').classList.add('active'),event.target.classList.add('active'),indSignaturePad||(indSignaturePad=new SignaturePad(document.getElementById('sig-canvas-ind')))):(document.getElementById('sig-upload-box').classList.add('active'),event.target.classList.add('active'))}
    function toggleBusSig(t){document.querySelectorAll('.sig-method').forEach(e=>e.classList.remove('active'));document.getElementById('sig-draw-box-bus').classList.remove('active');document.getElementById('sig-upload-box-bus').classList.remove('active');'draw'===t?(document.getElementById('sig-draw-box-bus').classList.add('active'),event.target.classList.add('active'),busSignaturePad||(busSignaturePad=new SignaturePad(document.getElementById('sig-canvas-bus')))):(document.getElementById('sig-upload-box-bus').classList.add('active'),event.target.classList.add('active'))}
    function clearIndSig(){indSignaturePad&&indSignaturePad.clear()}function clearBusSig(){busSignaturePad&&busSignaturePad.clear()}
    function validateAndProceed(t,e,o){if(validateStep(t,e))'ind'===t?showIndStep(o):showBusStep(o)}
    function validateStep(t,e){return'ind'===t?validateIndStep(e):validateBusStep(e)}
    function validateIndStep(t){
        if(1===t){
            let e=document.getElementById('ind-amt').value,o=document.getElementById('ind-purpose').value,a=document.getElementById('ind-period').value;
            if(!e||!o||!a)return alert("Please fill all required fields in Loan Details."),!1;
            if(parseFloat(e)<100)return alert("Minimum loan amount is K100."),!1;
        }else if(2===t){
            let e=document.querySelectorAll('input[name="collateral"]:checked').length>0,o=document.getElementById('other-checkbox').checked,a=document.getElementById('other-description').value,n=document.getElementById('ind-description').value,l=document.getElementById('ind-collateral-photos').files;
            if(!e&&!o)return alert("Please select at least one collateral item or specify in 'Other' category."),!1;
            if(o&&!a.trim())return alert("Please describe your collateral item in the 'Other' field."),!1;
            if(!n.trim())return alert("Please describe the item's condition."),!1;
            if(0===l.length)return alert("Please upload at least one photo of your collateral item(s)."),!1;
            document.getElementById('other-description-hidden').value=a;
        }else if(3===t){
            let e=document.getElementById('ind-name').value,o=document.getElementById('ind-dob').value,a=document.getElementById('ind-nrc').value,n=document.getElementById('ind-email').value,l=document.getElementById('ind-phone').value,i=document.getElementById('ind-address').value,s=document.getElementById('ind-identity').files[0],d=document.getElementById('ind-residence').files[0];
            if(!e||!o||!a||!n||!l||!i)return alert("Please fill all required personal information fields."),!1;
            if(!/^\S+@\S+\.\S+$/.test(n))return alert("Please enter a valid email address."),!1;
            if(!s)return alert("Please upload Proof of Identity."),!1;
            if(!d)return alert("Please upload Proof of Residence."),!1;
            if(!/^\d{6}\/\d{2}\/\d{1}$/.test(a))return alert("Please enter NRC in format: 123456/78/9"),!1;
        }
        return!0
    }
    function validateBusStep(t){
        if(1===t){
            let e=document.getElementById('bus-name').value,o=document.getElementById('bus-reg').value,a=document.getElementById('bus-contact-name').value,n=document.getElementById('bus-contact-email').value,l=document.getElementById('bus-contact-phone').value;
            if(!e||!o||!a||!n||!l)return alert("Please fill all required business details."),!1;
            if(!/^\S+@\S+\.\S+$/.test(n))return alert("Please enter a valid email address for contact person."),!1;
        }else if(2===t){
            let e=document.getElementById('bus-amt').value,o=document.getElementById('bus-purpose').value,a=document.getElementById('bus-reason').value,n=document.getElementById('bus-period').value;
            if(!e||!o||!a||!n)return alert("Please fill all required loan request fields."),!1;
            if(parseFloat(e)<1e3)return alert("Minimum business loan amount is K1,000."),!1;
        }else if(3===t){
            let e=document.getElementById('bus-collateral-type').value,o=document.getElementById('bus-collateral-desc').value,a=document.getElementById('bus-collateral-value').value,n=document.getElementById('bus-collateral-proof').files[0],l=document.getElementById('bus-collateral-photos').files;
            if(!e||!o||!a||!n)return alert("Please fill all required collateral information."),!1;
            if(0===l.length)return alert("Please upload at least one photo of your business collateral."),!1;
        }else if(4===t){
            let e=document.getElementById('bus-reg-cert').files[0],o=document.getElementById('bus-tax-cert').files[0],a=document.getElementById('bus-directors-id').files[0],n=document.getElementById('bus-address-proof').files[0];
            if(!e||!o||!a||!n)return alert("Please upload all required business documents."),!1;
        }
        return!0
    }
    document.getElementById('individualForm').onsubmit=function(t){
        let e=document.querySelector('#ind-step4 .sig-method.active')?.textContent.trim();
        if('Draw Signature'===e){
            if(!indSignaturePad||indSignaturePad.isEmpty())return alert("Please provide your signature."),t.preventDefault(),!1;
            document.getElementById('ind-signature-data').value=indSignaturePad.toDataURL()
        }else if(!document.getElementById('ind-sig-upload').files[0])return alert("Please upload your signature."),t.preventDefault(),!1;
        if(!document.getElementById('ind-agreement').checked)return alert("Please agree to the terms and conditions."),t.preventDefault(),!1;
        showAlert('Submitting your personal loan application...','info')
    };
    document.getElementById('businessForm').onsubmit=function(t){
        let e=document.querySelector('#bus-step5 .sig-method.active')?.textContent.trim();
        if('Draw Signature'===e){
            if(!busSignaturePad||busSignaturePad.isEmpty())return alert("Please provide your signature."),t.preventDefault(),!1;
            document.getElementById('bus-signature-data').value=busSignaturePad.toDataURL()
        }else if(!document.getElementById('bus-sig-upload').files[0])return alert("Please upload your signature."),t.preventDefault(),!1;
        if(!document.getElementById('bus-agreement').checked)return alert("Please agree to the terms and conditions."),t.preventDefault(),!1;
        showAlert('Submitting your business loan application...','info')
    };
    function showAlert(t,e){document.querySelectorAll('.alert').forEach(o=>o.remove());let a=document.createElement('div');a.className=`alert alert-${e}`;a.innerHTML=`${t}<button class="alert-close" onclick="this.parentElement.style.display='none'">×</button>`;document.querySelector('.main-content').insertBefore(a,document.querySelector('.main-content').firstChild);'info'===e&&setTimeout(()=>{a.parentElement&&(a.style.display='none')},1e4)}
    document.addEventListener('DOMContentLoaded',function(){
        let t=document.getElementById('other-checkbox');
        t&&t.addEventListener('change',function(){
            if(this.checked){
                document.getElementById('other-input').classList.add('active');
                let t=document.querySelector('.category-btn:nth-child(4)');
                t&&showItems('other',t)
            }else document.getElementById('other-input').classList.remove('active')
        });
        updateIndCalc();updateBusCalc();
        let e=document.getElementById('backend-message');
        e&&setTimeout(()=>{e.style.display='none'},1e4)
    });
</script>
</body>
</html>
{% endblock %}